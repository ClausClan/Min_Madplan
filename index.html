<!DOCTYPE html>
<html lang="da">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Min Madplan App</title>

    <style>
        /* --- 1. Grundlæggende Styling --- */
        :root {
            --primær-farve: #4CAF50; /* Grøn */
            --sekundær-farve: #FFC107; /* Rav */
            --advarsel-farve: #D32F2F; /* Rød */
            --tekst-farve: #333;
            --lys-grå: #f4f4f4;
            --grænse-farve: #ddd;
            --hvid: #ffffff;
            --knap-aktiv: #45a049;
        }

        /* --- NYT: Splash Skærm --- */
        #splash-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: var(--primær-farve); /* Bruger din grønne farve */
            color: var(--hvid);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 9999;
            transition: opacity 0.5s ease-out;
        }
        .splash-title {
            font-size: 2.5rem;
            font-weight: bold;
            margin-bottom: 1rem;
        }
        .splash-logo {
            width: 100px;
            height: 100px;
            margin-bottom: 1rem;
        }
        .splash-subtitle {
            font-size: 1.2rem;
            font-weight: 300;
        }
        /* Skjul splash skærm */
        #splash-screen.hidden {
            opacity: 0;
            pointer-events: none;
        }


        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        html, body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--lys-grå);
            color: var(--tekst-farve);
            height: 100%;
        }

        body {
            display: flex;
            justify-content: center;
        }

        /* --- 2. App Container --- */
        #app-container {
            width: 100%;
            max-width: 600px; /* Mobil-bredde */
            height: 100%;
            background-color: var(--hvid);
            box-shadow: 0 0 20px rgba(0,0,0,0.1);
            display: flex;
            flex-direction: column;
            overflow: hidden; /* Forhindrer scroll på hele appen */
        }

        header {
            background-color: var(--primær-farve);
            color: var(--hvid);
            padding: 1.2rem 1rem;
            text-align: center;
        }

        /* RETTET: Stile til din nye Logo-header */
        .logo-h1 {
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0;
            font-size: 1.5rem;
        }
        .logo-svg {
            width: 30px; /* Juster størrelse efter behov */
            height: 30px;
            margin-right: 0.5rem;
        }

        main {
            flex-grow: 1; /* Fylder resten af højDEN */
            overflow-y: auto; /* Tillader scroll KUN på main-indholdet */
            padding: 1rem;
            padding-bottom: 80px; /* Plads til bundmenuen */
        }

        /* --- 3. Skærm-styring (Tabs) --- */
        .app-skærm {
            display: none; /* Skjult som standard */
        }

        .app-skærm.active {
            display: block; /* Vises når aktiv */
        }

        /* --- 4. Bund-navigation --- */
        #app-nav {
            position: fixed;
            bottom: 0;
            width: 100%;
            max-width: 600px; /* Matcher container */
            display: flex;
            background-color: var(--hvid);
            border-top: 1px solid var(--grænse-farve);
            z-index: 100;
        }

        #app-nav button {
            flex-grow: 1;
            padding: 1rem 0.5rem;
            font-size: 0.8rem;
            font-weight: bold;
            text-transform: uppercase;
            color: var(--tekst-farve);
            background: none;
            border: none;
            cursor: pointer;
            transition: background-color 0.2s;
        }

        #app-nav button:hover {
            background-color: var(--lys-grå);
        }

        #app-nav button.active-tab {
            color: var(--primær-farve);
            border-top: 3px solid var(--primær-farve);
            padding-top: calc(1rem - 3px);
        }

        /* --- 5. Generelle Komponenter (Knapper, Felter) --- */
        h2 {
            font-size: 1.3rem;
            margin-bottom: 1rem;
            color: var(--primær-farve);
            border-bottom: 2px solid var(--lys-grå);
            padding-bottom: 0.5rem;
        }

        label {
            display: block;
            font-weight: bold;
            margin-top: 1rem;
            margin-bottom: 0.5rem;
        }

        textarea {
            width: 100%;
            min-height: 100px;
            padding: 0.75rem;
            border: 1px solid var(--grænse-farve);
            border-radius: 8px;
            font-family: inherit;
            font-size: 1rem;
            resize: vertical;
        }

        textarea[readonly] {
            background-color: var(--lys-grå);
        }
        
        .input-felt {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid var(--grænse-farve);
            border-radius: 8px;
            font-family: inherit;
            font-size: 1rem;
        }
        
        .input-gruppe {
            background-color: var(--lys-grå);
            border: 1px solid var(--grænse-farve);
            border-radius: 8px;
            padding: 1rem;
            margin: 1rem 0;
        }
        
        .grid-2 {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
        }

        .btn {
            display: inline-block;
            width: 100%;
            padding: 1rem;
            font-size: 1rem;
            font-weight: bold;
            color: var(--hvid);
            background-color: var(--primær-farve);
            border: none;
            border-radius: 8px;
            cursor: pointer;
            text-align: center;
            margin-top: 1rem;
            transition: background-color 0.2s;
        }

        .btn:hover {
            background-color: var(--knap-aktiv);
        }

        .btn-sekundær {
            background-color: var(--sekundær-farve);
            color: #333;
        }
        .btn-sekundær:hover {
            background-color: #ffb300;
        }

        /* --- 6. Skærm: Setup (#setup) --- */
        .lille-note {
            font-size: 0.9rem;
            color: #555;
            margin-bottom: 1rem;
            margin-top: -0.5rem;
        }
        
        .tilbuds-linje {
            display: flex;
            align-items: center;
            margin-bottom: 0.75rem;
            background: var(--hvid);
            padding: 0.5rem;
            border-radius: 8px;
        }
        
        .tilbuds-linje input[type="checkbox"] {
            margin-right: 0.5rem;
            transform: scale(1.2);
        }
        
        .tilbuds-linje label {
            margin: 0;
            font-weight: bold;
            flex-grow: 1;
        }
        
        .btn-lille-link {
            padding: 0.5rem 0.75rem;
            background-color: var(--primær-farve);
            color: var(--hvid);
            text-decoration: none;
            border-radius: 6px;
            font-size: 0.9rem;
            font-weight: bold;
            transition: background-color 0.2s;
        }
        .btn-lille-link:hover {
            background-color: var(--knap-aktiv);
        }
        
        #prompt-output-container {
            margin-top: 1.5rem;
            border-top: 2px solid var(--lys-grå);
            padding-top: 1rem;
        }

        /* --- 7. Skærm: Madplan (#madplan) --- */
        .uge-oversigt {
            list-style: none;
        }

        .dag-kort {
            background-color: var(--hvid);
            border: 1px solid var(--grænse-farve);
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 0.75rem;
            cursor: pointer;
            transition: box-shadow 0.2s;
        }

        .dag-kort:hover {
            box-shadow: 0 4px 10px rgba(0,0,0,0.05);
        }

        .dag-kort h3 {
            font-size: 1.1rem;
            color: var(--primær-farve);
            margin-bottom: 0.25rem;
        }

        .dag-kort p {
            font-size: 1rem;
            color: var(--tekst-farve);
        }


        /* --- 8. Skærm: Opskrift (#opskrift) --- */
        #opskrift-container {
            padding-bottom: 1rem;
        }

        #opskrift-container .btn-tilbage {
            width: auto;
            display: inline-block;
            padding: 0.5rem 1rem;
            font-size: 0.9rem;
            background-color: var(--lys-grå);
            color: var(--tekst-farve);
            margin-bottom: 1rem;
        }
        #opskrift-container .btn-tilbage:hover {
             background-color: var(--grænse-farve);
        }

        #opskrift-container h3 {
            font-size: 1.1rem;
            margin-top: 1.5rem;
            margin-bottom: 0.5rem;
        }

        #opskrift-ingredienser li,
        #opskrift-fremgangsmåde li {
            margin-left: 1.2rem;
            margin-bottom: 0.5rem;
            line-height: 1.4;
        }

        /* --- Styling til sorteringsknapper --- */
        #sortering-knapper {
            display: flex;
            justify-content: space-between;
            margin-bottom: 1rem;
            gap: 0.5rem;
        }

        #sortering-knapper button {
            flex-grow: 1;
            padding: 0.75rem 0.5rem;
            font-size: 0.9rem;
            font-weight: bold;
            background-color: var(--lys-grå);
            color: var(--tekst-farve);
            border: 1px solid var(--grænse-farve);
            border-radius: 8px;
            cursor: pointer;
            transition: background-color 0.2s, color 0.2s;
        }

        #sortering-knapper button:hover {
            background-color: var(--grænse-farve);
        }

        #sortering-knapper button.active {
            background-color: var(--primær-farve);
            color: var(--hvid);
            border-color: var(--primær-farve);
        }

        /* --- 9. Skærm: Indkøb (#indkøb) --- */
        #indkøbsliste {
            list-style: none;
        }

        .indkøbs-item {
            font-size: 1.1rem;
            padding: 1rem 0.5rem;
            border-bottom: 1px solid var(--grænse-farve);
            cursor: pointer;
            user-select: none; /* Forhindrer tekst-markering ved klik */
            display: flex;
            align-items: center;
        }
        
        /* Simpel "checkbox" effekt */
        .indkøbs-item::before {
            content: '☐';
            display: inline-block;
            margin-right: 0.75rem;
            font-size: 1.3rem;
            color: var(--grænse-farve);
        }

        .indkøbs-item.checked {
            color: #999;
            text-decoration: line-through;
        }

        .indkøbs-item.checked::before {
            content: '☑';
            color: var(--primær-farve);
        }

        /* --- STIL TIL SLET-KNAP --- */
        .btn-advarsel {
            background-color: var(--advarsel-farve);
        }
        .btn-advarsel:hover {
            background-color: #B71C1C; /* Mørkere rød */
        }
    </style>
</head>
<body>

    <div id="splash-screen">
        <h1 class="splash-title">KøkkenKlog</h1>
        <img src="logo.png" alt="KøkkenKlog Logo" class="splash-logo">
        <p class="splash-subtitle">Din Madplan gjort nemt</p>
    </div>

    <div id="app-container">

        <header>
            <h1 class="logo-h1"> 
                <img src="logo.png" alt="KøkkenKlog Logo" class="logo-svg">
                <span>KøkkenKlog</span>
            </h1>
        </header>

        <main>

            <section id="setup" class="app-skærm active">
                
                <h2>1. Målgruppe & Varighed</h2>
                <div class="input-gruppe">
                    <div class="grid-2">
                        <div>
                            <label for="input-voksne-antal">Antal voksne</label>
                            <input type="number" id="input-voksne-antal" class="input-felt" value="2" min="0">
                        </div>
                        <div>
                            <label for="input-boern-antal">Antal børn/teenagere</label>
                            <input type="number" id="input-boern-antal" class="input-felt" value="2" min="0">
                        </div>
                    </div>
                    <label for="input-voksne-alder">Voksnes alder (komma-separeret)</label>
                    <input type="text" id="input-voksne-alder" class="input-felt" value="45, 47" placeholder="f.eks. 45, 47">
                    
                    <label for="input-boern-alder">Børns alder (komma-separeret)</label>
                    <input type="text" id="input-boern-alder" class="input-felt" value="14, 17" placeholder="f.eks. 14, 17">

                    <label for="input-uger">Antal Uger (1-8)</label>
                    <input type="number" id="input-uger" class="input-felt" value="1" min="1" max="8">

                    <label for="input-allergi">Allergier & Emner der skal undgås</label>
                    <textarea id="input-allergi" rows="3" placeholder="f.eks.&#10;Nødder (alle slags)&#10;Skaldyr&#10;Kan ikke lide svampe"></textarea>
                </div>

                <h2>2. Aviser & Tilbud</h2>
                <div class="input-gruppe">
                    <p class="lille-note">Download selv avis som PDF. Tjek af, hvis du vedhæfter den til AI'en.</p>
                    
                    <div class="tilbuds-linje">
                        <input type="checkbox" id="check-netto" data-butik="Netto">
                        <label for="check-netto">Netto</label>
                        <a href="https://netto.dk/netto-avisen/?utm_source=google&utm_medium=cpc&utm_campaign=15716389084&utm_content=138433833104&utm_term=netto%20tilbudsavis&gclsrc=aw.ds&gad_source=1&gad_campaignid=15716389084&gbraid=0AAAAAoWqUbkUPc93WA7xqIH5WV6-PNl6H&gclid=CjwKCAjw04HIBhB8EiwA8jGNbc6STcuLObi0UG94OZ_xCX487N17TEuZF5B188SN4Jur1c1PZfI1QxoC9ZAQAvD_BwE" target="_blank" rel="noopener" class="btn-lille-link">Åbn avis</a>
                    </div>

                    <div class="tilbuds-linje">
                        <input type="checkbox" id="check-netto-oeko" data-butik="Netto Øko">
                        <label for="check-netto-oeko">Netto_øko</label>
                        <a href="https://sgn-prd-assets.s3.eu-west-1.amazonaws.com/uploads/businesses/9ba51/rbA9q0AJ5w7jS4Ktli7sN?X-Amz-Algorithm=AWS4-HMAC-SHA256&X-Amz-Content-Sha256=UNSIGNED-PAYLOAD&X-Amz-Credential=AKIAQRECTWG3NTGXRMV7%2F20251029%2Feu-west-1%2Fs3%2Faws4_request&X-Amz-Date=20251029T175420Z&X-Amz-Expires=600&X-Amz-Signature=8367c3e6557e5702ba415276952dafe1629548989391cf3f9cc375739de9841f&X-Amz-SignedHeaders=host&x-amz-checksum-mode=ENABLED&x-id=GetObject" target="_blank" rel="noopener" class="btn-lille-link">Åbn avis</a>
                    </div>
                    <div class="tilbuds-linje">
                        <input type="checkbox" id="check-rema" data-butik="Rema 1000">
                        <label for="check-rema">Rema 1000</label>
                        <a href="https://shop.rema1000.dk/avis/" target="_blank" rel="noopener" class="btn-lille-link">Åbn avis</a>
                    </div>
                    <div class="tilbuds-linje">
                        <input type="checkbox" id="check-coop365" data-butik="Coop 365">
                        <label for="check-coop365">Coop 365</label>
                        <a href="https://365discount.coop.dk/365avis/" target="_blank" rel="noopener" class="btn-lille-link">Åbn avis</a>
                    </div>

                    <div class="tilbuds-linje">
                        <input type="checkbox" id="check-coop365-ugeavis" data-butik="Coop 365 Ugeavis">
                        <label for="check-coop365-ugeavis">Coop365Ugeavis</label>
                        <a href="https://sgn-prd-assets.s3.eu-west-1.amazonaws.com/uploads/businesses/DWZE1w/L58-7u0dV3tXss1S6ng4f?X-Amz-Algorithm=AWS4-HMAC-SHA256&X-Amz-Content-Sha256=UNSIGNED-PAYLOAD&X-Amz-Credential=AKIAQRECTWG3NTGXRMV7%2F20251029%2Feu-west-1%2Fs3%2Faws4_request&X-Amz-Date=20251029T181300Z&X-Amz-Expires=600&X-Amz-Signature=4815c38644ad726818d799227897da3d0cb31dde502475a4bfc3161e1cf9430a&X-Amz-SignedHeaders=host&x-amz-checksum-mode=ENABLED&x-id=GetObject" target="_blank" rel="noopener" class="btn-lille-link">Åbn avis</a>
                    </div>

                    <div class="tilbuds-linje">
                        <input type="checkbox" id="check-bilka" data-butik="Bilka">
                        <label for="check-bilka">Bilka Avis</label>
                        <a href="https://www.bilka.dk/bilkaavisen/?utm_source=google&utm_medium=cpc&utm_campaign=15058154379&utm_content=134559319811&utm_term=bilka%20tilbudsavis&gclsrc=aw.ds&gad_source=1&gad_campaignid=15058154379&gbraid=0AAAAAoN7jvu6MBnkV00fSnir3xuBcG0vS&gclid=CjwKCAjw04HIBhB8EiwA8jGNbYHpj8V1TnI4Pws4cPKLIJHCoTf1yyLxxohvCDJ56JjvKNY56-lZRRoCUXwQAvD_BwE" target="_blank" rel="noopener" class="btn-lille-link">Åben Avis</a>
                    </div>
                </div>

                <h2>3. Dine varer</h2>
                
                <label for="input-lager">Lager (Stop Madspild - AI Prioritet 1)</label>
                <textarea id="input-lager" rows="4" placeholder="f.eks.&#10;200g røde linser&#10;1 dåse kokosmælk&#10;En rest pasta"></textarea>

                <label for="input-tilbud">Manuelle Tilbud (AI Prioritet 2)</label>
                <textarea id="input-tilbud" rows="4" placeholder="f.eks.&#10;Hakket oksekød 500g 30 kr&#10;Spidskål 5 kr"></textarea>

                <label for="input-basis">Almindelige Basisvarer (AI Prioritet 3)</label>
                <textarea id="input-basis" rows="4" placeholder="f.eks.&#10;Mel, sukker, salt&#10;Olie, eddike&#10;Løg, hvidløg, kartofler&#10;Krydderier"></textarea>

                <button id="btn-generer-prompt" class="btn">Generer Prompt til AI</button>

                <div id="prompt-output-container" style="display: none;">
                    <h2>4. Kopier Prompt</h2>
                    <p>Sæt prompten ind i din AI og **husk at vedhæfte de PDF'er**, du tjekkede af!</p>
                    <textarea id="prompt-output" rows="10" readonly></textarea>
                </div>

                <div id="json-input-container" style="display: none;">
                    <h2>5. Indsæt Madplan (JSON)</h2>
                    <p>Kopier AI'ens fulde JSON-svar og indsæt det herunder.</p>
                    <textarea id="json-input" rows="8" placeholder="Indsæt JSON-koden her..."></textarea>
                    <button id="btn-indlæs-json" class="btn btn-sekundær">Indlæs Madplan</button>
                </div>

                <div id="slet-container" style="display: none; margin-top: 2rem; border-top: 2px solid var(--grænse-farve); padding-top: 1rem;">
                    <h2>Nulstil App</h2>
                    <p>Dette sletter den gemte madplan fra din browser og lader dig starte forfra.</p>
                    <button id="btn-slet-data" class="btn btn-advarsel">Slet Gemt Madplan</button>
                </div>
            </section>

            <section id="madplan" class="app-skærm">
                <h2 id="uge-titel">Uge 1</h2>
                
                <ul class="uge-oversigt">
                    </ul>

                <button id="btn-næste-uge">Næste Uge</button>
                <button id="btn-forrige-uge">Forrige Uge</button>

            </section>

            <section id="opskrift" class="app-skærm">
                <div id="opskrift-container">
                    <button class="btn-tilbage" id="btn-tilbage-til-uge">&larr; Tilbage til ugeplan</button>
                    
                    <h2 id="opskrift-titel">Opskrift Titel</h2>

                    <h3>Ingredienser</h3>
                    <ul id="opskrift-ingredienser">
                        </ul>

                    <h3>Fremgangsmåde</h3>
                    <ol id="opskrift-fremgangsmåde">
                        </ol>
                </div>
            </section>

            <section id="indkøb" class="app-skærm">
                <h2 id="indkøbsliste-titel">Indkøbsliste (Uge 1)</h2>
                
                <div id="sortering-knapper">
                    <button data-sort="navn" class="active">A-Å</button>
                    <button data-sort="kategori">Kategori</button>
                    <button data-sort="dag">Dag</button>
                    <button data-sort="butik">Butik</button>
                </div>
                
                <ul id="indkøbsliste">
                    </ul>
            </section>

        </main>

        <nav id="app-nav">
            <button class="nav-btn active-tab" data-skærm="setup">Setup</button>
            <button class="nav-btn" data-skærm="madplan">Madplan</button>
            <button class="nav-btn" data-skærm="indkøb">Indkøb</button>
        </nav>

    </div> <script>
        // Tjek om browseren understøtter service workers
        if ('serviceWorker' in navigator) {
            // Vent til siden er fuldt indlæst, før vi registrerer
            window.addEventListener('load', () => {
                // RETTELSE: Brug relativ sti (./) til GitHub Pages
                navigator.serviceWorker.register('./service-worker.js')
                    .then((registration) => {
                        console.log('Service Worker registreret succesfuldt:', registration);
                    })
                    .catch((error) => {
                        console.error('Service Worker registrering fejlede:', error);
                    });
            });
        }
    </script>

    <script>
        document.addEventListener('DOMContentLoaded', () => {

            // --- Globale Variabler ---
            let globalMadplanData = null;
            let nuværendeUgeIndex = 0;
            let nuværendeSortering = 'navn'; 
            
            // --- Globale referencer til skærme og titel ---
            const skærme = document.querySelectorAll('.app-skærm');
            // appTitel er fjernet, da vi bruger logo-headeren
            const madplanSkærm = document.getElementById('madplan');
            const opskriftSkærm = document.getElementById('opskrift');
            const setupSkærm = document.getElementById('setup');

            // --- Referencer til UI-elementer, der skal opdateres ---
            const ugeTitel = document.getElementById('uge-titel');
            const ugeOversigtContainer = document.querySelector('.uge-oversigt');
            const indkøbslisteTitel = document.getElementById('indkøbsliste-titel');
            const indkøbslisteContainer = document.getElementById('indkøbsliste');
            const opskriftTitel = document.getElementById('opskrift-titel');
            const opskriftIngredienser = document.getElementById('opskrift-ingredienser');
            const opskriftFremgangsmåde = document.getElementById('opskrift-fremgangsmåde');
            const btnNæsteUge = document.getElementById('btn-næste-uge');
            const btnForrigeUge = document.getElementById('btn-forrige-uge');
            const sletContainer = document.getElementById('slet-container');
            const btnSletData = document.getElementById('btn-slet-data');

            // --- Referencer til Setup-skærm elementer ---
            const btnGenererPrompt = document.getElementById('btn-generer-prompt');
            const inputUger = document.getElementById('input-uger');
            const inputTilbud = document.getElementById('input-tilbud');
            const inputLager = document.getElementById('input-lager');
            const inputBasis = document.getElementById('input-basis');
            const promptOutputContainer = document.getElementById('prompt-output-container');
            const promptOutput = document.getElementById('prompt-output');
            const jsonInputContainer = document.getElementById('json-input-container');
            
            // Referencer til målgruppe-felter
            const inputVoksneAntal = document.getElementById('input-voksne-antal');
            const inputVoksneAlder = document.getElementById('input-voksne-alder');
            const inputBoernAntal = document.getElementById('input-boern-antal');
            const inputBoernAlder = document.getElementById('input-boern-alder');
            const inputAllergi = document.getElementById('input-allergi'); // NYT

            // Referencer til tjekbokse
            const checkNetto = document.getElementById('check-netto');
            const checkNettoOeko = document.getElementById('check-netto-oeko');
            const checkRema = document.getElementById('check-rema');
            const checkCoop365 = document.getElementById('check-coop365');
            const checkCoop365Ugeavis = document.getElementById('check-coop365-ugeavis');
            const checkBilka = document.getElementById('check-bilka');


            // ===================================================
            // NAVIGATION
            // ===================================================

            const navKnapper = document.querySelectorAll('.nav-btn');

            function skiftSkærm(skærmId) {
                skærme.forEach(skærm => skærm.classList.remove('active'));
                navKnapper.forEach(knap => knap.classList.remove('active-tab'));

                const aktivSkærm = document.getElementById(skærmId);
                if (aktivSkærm) aktivSkærm.classList.add('active');

                const aktivKnap = document.querySelector(`.nav-btn[data-skærm="${skærmId}"]`);
                if (aktivKnap) {
                    aktivKnap.classList.add('active-tab');
                }
            }

            navKnapper.forEach(knap => {
                knap.addEventListener('click', () => {
                    const skærmId = knap.dataset.skærm;
                    skiftSkærm(skærmId);
                });
            });

            const tilbageKnap = document.getElementById('btn-tilbage-til-uge');
            
            function visOpskriftSkærm() {
                madplanSkærm.classList.remove('active');
                opskriftSkærm.classList.add('active');
            }

            function visMadplanSkærm() {
                opskriftSkærm.classList.remove('active');
                madplanSkærm.classList.add('active');
            }

            tilbageKnap.addEventListener('click', visMadplanSkærm);

            // ===================================================
            // FASE 3: Funktioner til at Vise Data (Render)
            // ===================================================

            function renderUgeplan(ugeIndex) {
                if (!globalMadplanData) return;
                const uge = globalMadplanData.uger[ugeIndex];
                if (!uge) return;

                ugeTitel.textContent = `Uge ${uge.ugeNummer}`;
                ugeOversigtContainer.innerHTML = '';

                uge.dage.forEach((dag, dagIndex) => {
                    const li = document.createElement('li');
                    li.className = 'dag-kort';
                    li.dataset.dagIndex = dagIndex;
                    li.innerHTML = `
                        <h3>${dag.dag}</h3>
                        <p>${dag.retNavn}</p>
                    `;
                    ugeOversigtContainer.appendChild(li);
                });

                btnForrigeUge.disabled = (ugeIndex === 0);
                btnNæsteUge.disabled = (ugeIndex >= globalMadplanData.uger.length - 1);
                
                if (globalMadplanData.uger.length <= 1) {
                    btnForrigeUge.style.display = 'none';
                    btnNæsteUge.style.display = 'none';
                } else {
                    btnForrigeUge.style.display = 'inline-block';
                    btnNæsteUge.style.display = 'inline-block';
                }
            }

            function renderOpskrift(ugeIndex, dagIndex) {
                if (!globalMadplanData) return;
                const dag = globalMadplanData.uger[ugeIndex].dage[dagIndex];
                if (!dag) return;

                opskriftTitel.textContent = dag.retNavn;
                opskriftIngredienser.innerHTML = '';
                opskriftFremgangsmåde.innerHTML = '';

                dag.ingredienser.forEach(item => {
                    const li = document.createElement('li');
                    li.textContent = `${item.mængde} ${item.navn}`;
                    opskriftIngredienser.appendChild(li);
                });

                const steps = dag.fremgangsmåde.split(/\d+\.\s/).filter(step => step.trim() !== '');
                steps.forEach(step => {
                    const li = document.createElement('li');
                    li.textContent = step.trim();
                    opskriftFremgangsmåde.appendChild(li);
                });
            }

            function renderIndkøbsliste(ugeIndex) {
                if (!globalMadplanData) return;
                
                const uge = globalMadplanData.uger[ugeIndex];
                if (!uge || !uge.indkøbsliste) return;

                indkøbslisteTitel.textContent = `Indkøbsliste (Uge ${uge.ugeNummer})`;
                
                uge.indkøbsliste.forEach(item => item.checked = false); 

                sorterOgVisIndkøbsliste();
            }

            function sorterOgVisIndkøbsliste() {
                if (!globalMadplanData) return;

                let uge = globalMadplanData.uger[nuværendeUgeIndex];
                if (!uge || !uge.indkøbsliste) return;

                let listeKopi = [...uge.indkøbsliste];
                const dagOrden = ["Mandag", "Tirsdag", "Onsdag", "Torsdag", "Fredag", "Lørdag", "Søndag"];

                listeKopi.sort((a, b) => {
                    const aVal = a[nuværendeSortering] || '';
                    const bVal = b[nuværendeSortering] || '';

                    if (nuværendeSortering === 'dag') {
                        return (dagOrden.indexOf(aVal) || 99) - (dagOrden.indexOf(bVal) || 99);
                    }
                    
                    return aVal.localeCompare(bVal, 'da', { sensitivity: 'base' });
                });

                indkøbslisteContainer.innerHTML = '';

                listeKopi.forEach((item, index) => {
                    const li = document.createElement('li');
                    li.className = 'indkøbs-item';
                    li.dataset.originalIndex = uge.indkøbsliste.indexOf(item); 
                    
                    let tekst = item.navn;

                    if (item.pris) {
                        let prisTekst = typeof item.pris === 'number' ? item.pris.toFixed(2) : item.pris;
                        tekst += ` - ${prisTekst} kr.`;
                    }
                    
                    if (item.mængde) tekst += ` (${item.mængde})`;
                    
                    let noteTekst = [item.note];
                    if (nuværendeSortering === 'kategori' && item.kategori) {
                        noteTekst.push(`Kat: ${item.kategori}`);
                    } else if (nuværendeSortering === 'dag' && item.dag) {
                        noteTekst.push(`Dag: ${item.dag}`);
                    } else if (nuværendeSortering === 'butik' && item.butik) {
                        noteTekst.push(`Butik: ${item.butik}`);
                    }
                    
                    let filtreretNote = noteTekst.filter(Boolean).join(', '); 
                    if (filtreretNote) {
                        tekst += ` - *${filtreretNote}*`;
                    }
                    
                    li.textContent = tekst;
                    
                    if (item.checked) {
                        li.classList.add('checked');
                    }

                    indkøbslisteContainer.appendChild(li);
                });
            }


            // ===================================================
            // FASE 5: Funktion til at Indlæse JSON
            // ===================================================

            const btnIndlæsJson = document.getElementById('btn-indlæs-json');
            const jsonInput = document.getElementById('json-input');

            function indlæsJSON() {
                const jsonTekst = jsonInput.value;
                if (!jsonTekst.trim()) {
                    alert("Indsæt venligst JSON-data i feltet.");
                    return;
                }

                try {
                    const data = JSON.parse(jsonTekst);

                    if (data && data.madplan && data.madplan.uger && data.madplan.uger.length > 0) {
                        
                        globalMadplanData = data.madplan;
                        nuværendeUgeIndex = 0; 

                        localStorage.setItem('minMadplanData', JSON.stringify(globalMadplanData));
                        
                        renderUgeplan(nuværendeUgeIndex);
                        renderIndkøbsliste(nuværendeUgeIndex); 

                        skiftSkærm('madplan');

                        sletContainer.style.display = 'block';
                        jsonInput.value = '';

                    } else {
                        alert("JSON-dataen ser ikke ud til at have det korrekte format. (Mangler 'madplan' eller 'uger')");
                    }
                } catch (error) {
                    console.error("Fejl ved JSON parsing:", error);
                    alert("Ugyldigt JSON-format. Kunne ikke indlæse madplanen. \nFejl: " + error.message);
                }
            }

            btnIndlæsJson.addEventListener('click', indlæsJSON);


            // ===================================================
            // FASE 4: PROMPT-GENERERING (OPDATERET)
            // ===================================================

            function formaterInputTilPrompt(rawText) {
                if (!rawText.trim()) return "";
                const lines = rawText.split('\n');
                return lines
                    .filter(line => line.trim() !== '')
                    .map(line => `    "${line.replace(/"/g, '\\"')}"`)
                    .join(',\n');
            }

            function genererPrompt() {
                // 1. Hent alle basis-værdier
                const antalUger = inputUger.value || 1;
                const lagerTekst = formaterInputTilPrompt(inputLager.value);
                const basisTekst = formaterInputTilPrompt(inputBasis.value);
                const manuelleTilbudTekst = formaterInputTilPrompt(inputTilbud.value);
                const allergiTekst = formaterInputTilPrompt(inputAllergi.value); // NYT

                // 2. Byg "Målgruppe"-sektionen dynamisk
                let målgruppeTekst = [];
                if (inputVoksneAntal.value > 0) {
                    målgruppeTekst.push(`- Antal voksne: ${inputVoksneAntal.value} (Alder: ${inputVoksneAlder.value || 'ikke specificeret'})`);
                }
                if (inputBoernAntal.value > 0) {
                    målgruppeTekst.push(`- Antal børn/teenagere: ${inputBoernAntal.value} (Alder: ${inputBoernAlder.value || 'ikke specificeret'})`);
                }
                målgruppeTekst.push("- VIGTIGT: Planlæg portioner derefter. Aktive teenagere spiser ofte som eller mere end voksne.");
                const målgruppePrompt = målgruppeTekst.join('\n');


                // 3. Byg den dynamiske "Tilbud"-sektion
                let tilbudsAviser = [];
                if (checkNetto.checked) {
                    tilbudsAviser.push("den vedhæftede tilbudsavis fra Netto");
                }
                if (checkNettoOeko && checkNettoOeko.checked) {
                    tilbudsAviser.push("den vedhæftede tilbudsavis fra Netto Økologi");
                }
                if (checkRema.checked) {
                    tilbudsAviser.push("den vedhæftede tilbudsavis fra Rema 1000");
                }
                if (checkCoop365.checked) {
                    tilbudsAviser.push("den vedhæftede tilbudsavis fra Coop 365");
                }
                if (checkCoop365Ugeavis && checkCoop365Ugeavis.checked) {
                    tilbudsAviser.push("den vedhæftede tilbudsavis fra Coop 365 Ugeavis");
                }
                if (checkBilka && checkBilka.checked) {
                    tilbudsAviser.push("den vedhæftede tilbudsavis fra Bilka");
                }
                
                let avisInstruktion = tilbudsAviser.join(' og ');
                
                let tilbudSektionTekst = "";
                if (avisInstruktion) {
                    tilbudSektionTekst += `Gennemgå ${avisInstruktion} for at finde de bedste tilbud og byg madplanen op omkring dem. Udtræk prisen hvis muligt.`;
                }
                
                if (manuelleTilbudTekst) {
                    tilbudSektionTekst += `\nInkludér OGSÅ følgende specifikke tilbud, som jeg har fundet (udtræk pris fra disse):\n[\n${manuelleTilbudTekst}\n]`;
                }
                
                if (!tilbudSektionTekst) {
                    tilbudSektionTekst = "Der er ingen specifikke tilbud denne uge. Lav en prisfornuftig plan.";
                }

                // 4. Byg den nye, komplette prompt-skabelon
                const promptSkabelon = `
Generer en komplet madplan for ${antalUger} uger til aftensmad.
Outputtet skal være udelukkende i JSON-format. Generer kun den rene JSON-kodeblok, uden indledende eller afsluttende tekst.

### Målgruppe for madplanen:
${målgruppePrompt}

### Kost-Filosofi og Sundhedsprincipper (VIGTIGT!)
Maden skal være sund, næringsrig og primært baseret på **anti-inflammatoriske principper**. Portionerne skal være **mættende** for at dække energibehovet hos to aktive teenagere.

---
#### Videnskabelig Sammensætning & Målsætning
Hvert aftensmåltid skal være et komplet, ernæringsmæssigt afbalanceret måltid. Fokusér på følgende sammensætning:
* **Proteiner:** Sørg for en mættende og højkvalitets proteinkilde i HVERT måltid (bælgfrugter, linser, fisk, fjerkræ, æg) for at understøtte vækst, restitution og mæthed.
* **Kulhydrater:** Prioritér **komplekse, langsomt optagelige kulhydrater** (f.eks. fra rodfrugter, fuldkornsris, quinoa, søde kartofler, grove grøntsager) for at sikre stabil energi. Undgå hurtige, raffinerede kulhydrater (hvid pasta, hvidt brød).
* **Fedtstoffer:** Baser fedtindtaget på sunde, umættede kilder som **olivenolie**, **avocado**, **nødder**, **kerner** og **fed fisk**.

#### Bæredygtighed & Klimahensyn
* **Prioritér Bæredygtighed:** Planen skal afspejle en bæredygtig tilgang.
* **Minimér Madspild:** Dette er kernen i P1-lageret. Sørg for, at opskrifter kan bruge rester fra dagen før (f.eks. kan en rest kylling bruges i en salat).
* **Lavt Klimaaftryk:** Foretræk råvarer med lavt klimaaftryk. Dette understøttes af at prioritere grøntsager, fisk og fjerkræ over rødt kød.
---

* **Hovedfokus (Grøntsager):** Hver ret skal indeholde en betydelig mængde grøntsager (mindst 200-300g pr. person). Prioritér **danske årstidsbestemte grøntsager**.
* **Protein-variation:** Varier proteinkilderne. Inkludér **fed fisk (f.eks. laks, makrel) mindst 1-2 gange om ugen**.
* **Krydderier:** Vær generøs med anti-inflammatoriske krydderier som **gurkemeje**, **ingefær**, **hvidløg** og **chili**.
* **Reducér:** Minimer brugen af stærkt forarbejdede fødevarer, tilsat sukker og raffinerede kornprodukter.

### AI'ens prioritering for planlægning (VIGTIG ORDEN!)
1.  **Prioritet 1 (P1):** Indarbejd så mange varer som muligt fra "Prioriteret 'Stop-Madspild' Lager".
2.  **Prioritet 2 (P2):** Byg planen op omkring "Ugens Tilbud" (både fra vedhæftede filer og manuel input).
3.  **Prioritet 3 (P3):** Brug fra "Almindelige Basisvarer" efter behov.

### Regler for madplanen:
1.  **VIGTIGT - Undgå Emner:** Følgende emner må **ALDRIG** indgå i madplanen (pga. allergi eller stærke præferencer). Undgå selv hvis listen er tom:
[
${allergiTekst}
]
2.  **Varighed:** ${antalUger} hele uger.
3.  **Variation:** Den samme ret må maksimalt optræde 2 gange i løbet af de ${antalUger} uger.
4.  **Sundhed:** Følg "Kost-Filosofi" og "Videnskabelig Sammensætning" ovenfor.
5.  **Kød (Justeret):**
    * Maksimalt 3-4 aftensmåltider med kød (inkl. fjerkræ og fisk) om ugen.
    * Følg de officielle kostråd: Begræns det samlede indtag af **rødt kød** (okse, svin, lam) til **maksimalt 350 gram om ugen pr. person**. AI'en skal selv beregne den samlede ugentlige mængde for husstanden baseret på "Målgruppe".
    * Prioritér fisk og fjerkræ de dage, der er kød.
6.  **Økonomi:** Planen skal være prisfornuftig, minimere madspild og sigte efter et ca. månedligt madbudget på 4000 DKK. 40-60% økologisk.

### Input til planen:

1.  **Prioriteret 'Stop-Madspild' Lager (P1):** Forsøg at bruge følgende specifikke varer fra husstandens lager:
[
${lagerTekst}
]

2.  **Ugens Tilbud (P2):** Byg planen op omkring disse. For varer fundet i vedhæftede aviser, tilføj butiksnavn OG "På tilbud" til "note"-feltet (f.eks. "På tilbud i Netto"). Udtræk prisen til "pris"-feltet.
${tilbudSektionTekst}

3.  **Almindelige Basisvarer (P3):** Antag, at husstanden har følgende (disse skal ikke på indkøbslisten, medmindre de bruges op):
[
${basisTekst}
]

### Struktur for output (JSON-format):
Følg denne struktur nøjagtigt.
VIGTIGT FOR INDKØBSLISTE: For HVER vare på indkøbslisten SKAL du tilføje:
1.  'kategori': (f.eks. "Grønt", "Mejeri", "Kød", "Kolonial", "Frost")
2.  'butik': Butiksnavnet, hvis det er et tilbud (f.eks. "Netto", "Rema 1000"), ellers null.
3.  'dag': Den FØRSTE dag varen skal bruges i ugen (f.eks. "Mandag", "Tirsdag").
4.  'note': Butiksnavn + "På tilbud" for tilbudsvarer, ellers null.
5.  'pris': Varens pris (som et tal, f.eks. 30.00), hvis den fremgår af tilbudsavisen. Ellers null.

{
  "madplan": {
    "totalUger": ${antalUger},
    "uger": [
      {
        "ugeNummer": 1,
        "indkøbsliste": [
          { 
            "navn": "Hakket Oksekød", 
            "mængde": "500g", 
            "note": "På tilbud i Netto", 
            "butik": "Netto", 
            "kategori": "Kød", 
            "dag": "Mandag",
            "pris": 30.00
          },
          { 
            "navn": "Flåede tomater", 
            "mængde": "1 dåse", 
            "note": null, 
            "butik": null, 
            "kategori": "Kolonial", 
            "dag": "Mandag",
            "pris": null
          }
        ],
        "dage": [
          {
            "dag": "Mandag",
            "retNavn": "Kødsauce",
            "ingredienser": [
              { "navn": "Hakket Oksekød", "mængde": "500g" },
              { "navn": "Flåede tomater", "mængde": "1 dåse" }
            ],
            "fremgangsmåde": "1. Hak løg..."
          }
        ]
      }
    ]
  }
}
`;
                // 5. Sæt den genererede prompt ind i output-feltet
                promptOutput.value = promptSkabelon.trim();

                // 6. Vis de næste steps for brugeren
                promptOutputContainer.style.display = 'block';
                jsonInputContainer.style.display = 'block';
            }
            btnGenererPrompt.addEventListener('click', genererPrompt);


            // ===================================================
            // DYNAMISKE EVENT LISTENERS
            // ===================================================

            indkøbslisteContainer.addEventListener('click', (event) => {
                const itemElement = event.target.closest('.indkøbs-item');
                if (itemElement) {
                    itemElement.classList.toggle('checked');
                    
                    const originalIndex = itemElement.dataset.originalIndex;
                    if(globalMadplanData && globalMadplanData.uger[nuværendeUgeIndex].indkøbsliste[originalIndex]) {
                        let item = globalMadplanData.uger[nuværendeUgeIndex].indkøbsliste[originalIndex];
                        item.checked = !item.checked; 
                    }
                }
            });

            ugeOversigtContainer.addEventListener('click', (event) => {
                const kort = event.target.closest('.dag-kort');
                if (kort) {
                    const dagIndex = kort.dataset.dagIndex;
                    renderOpskrift(nuværendeUgeIndex, dagIndex);
                    visOpskriftSkærm();
                }
            });

            btnNæsteUge.addEventListener('click', () => {
                if (globalMadplanData && nuværendeUgeIndex < globalMadplanData.uger.length - 1) {
                    nuværendeUgeIndex++;
                    nuværendeSortering = 'navn'; 
                    renderUgeplan(nuværendeUgeIndex);
                    renderIndkøbsliste(nuværendeUgeIndex);
                }
            });

            btnForrigeUge.addEventListener('click', () => {
                if (nuværendeUgeIndex > 0) {
                    nuværendeUgeIndex--;
                    nuværendeSortering = 'navn'; 
                    renderUgeplan(nuværendeUgeIndex);
                    renderIndkøbsliste(nuværendeUgeIndex);
                }
            });

            function sletGemtData() {
                if (confirm("Er du sikker på, du vil slette den gemte madplan? Handlingen kan ikke fortrydes.")) {
                    localStorage.removeItem('minMadplanData');
                    globalMadplanData = null;
                    console.log("Gemt data slettet.");
                    location.reload();
                }
            }
            btnSletData.addEventListener('click', sletGemtData);
            
            const sorteringsKnapperContainer = document.getElementById('sortering-knapper');
            if (sorteringsKnapperContainer) {
                sorteringsKnapperContainer.addEventListener('click', (event) => {
                    if (event.target.tagName === 'BUTTON') {
                        const sortKey = event.target.dataset.sort;
                        nuværendeSortering = sortKey;
                        
                        sorteringsKnapperContainer.querySelectorAll('button').forEach(btn => {
                            btn.classList.remove('active');
                        });
                        event.target.classList.add('active');

                        sorterOgVisIndkøbsliste();
                    }
                });
            }


            // ===================================================
            // APP INITIALISERING (Start)
            // ===================================================
            
            function startApp() {
                const gemtData = localStorage.getItem('minMadplanData');
                if (gemtData) {
                    globalMadplanData = JSON.parse(gemtData);
                    nuværendeUgeIndex = 0;
                    
                    renderUgeplan(nuværendeUgeIndex);
                    renderIndkøbsliste(nuværendeUgeIndex);

                    skiftSkærm('madplan');
                    sletContainer.style.display = 'block';

                } else {
                    skiftSkærm('setup');
                    sletContainer.style.display = 'none';
                }
            }
            
            // Splash Skærm Logik
            const splashSkærm = document.getElementById('splash-screen');
            if(splashSkærm) {
                setTimeout(() => {
                    splashSkærm.classList.add('hidden');
                    setTimeout(() => {
                        splashSkærm.style.display = 'none';
                    }, 500); 

                    startApp(); // Kør appen!
                }, 2000); 
            } else {
                startApp(); // Kør appen med det samme hvis splash ikke findes
            }

        });
    </script>

</body>
</html>